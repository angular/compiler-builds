/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as o from '../../../../output/output_ast';
import * as ir from '../../ir';
/**
 * The escape sequence used indicate message param values.
 */
const ESCAPE = '\uFFFD';
/**
 * Marker used to indicate an element tag.
 */
const ELEMENT_MARKER = '#';
/**
 * Marker used to indicate a template tag.
 */
const TEMPLATE_MARKER = '*';
/**
 * Marker used to indicate closing of an element or template tag.
 */
const TAG_CLOSE_MARKER = '/';
/**
 * Marker used to indicate the sub-template context.
 */
const CONTEXT_MARKER = ':';
/**
 * Marker used to indicate the start of a list of values.
 */
const LIST_START_MARKER = '[';
/**
 * Marker used to indicate the end of a list of values.
 */
const LIST_END_MARKER = ']';
/**
 * Delimiter used to separate multiple values in a list.
 */
const LIST_DELIMITER = '|';
/**
 * Flags that describe what an i18n param value. These determine how the value is serialized into
 * the final map.
 */
var I18nParamValueFlags;
(function (I18nParamValueFlags) {
    I18nParamValueFlags[I18nParamValueFlags["None"] = 0] = "None";
    /**
     *  This value represtents an element tag.
     */
    I18nParamValueFlags[I18nParamValueFlags["ElementTag"] = 1] = "ElementTag";
    /**
     * This value represents a template tag.
     */
    I18nParamValueFlags[I18nParamValueFlags["TemplateTag"] = 2] = "TemplateTag";
    /**
     * This value represents the opening of a tag.
     */
    I18nParamValueFlags[I18nParamValueFlags["OpenTag"] = 4] = "OpenTag";
    /**
     * This value represents the closing of a tag.
     */
    I18nParamValueFlags[I18nParamValueFlags["CloseTag"] = 8] = "CloseTag";
})(I18nParamValueFlags || (I18nParamValueFlags = {}));
/**
 * Represents the complete i18n params map for an i18n op.
 */
class I18nPlaceholderParams {
    constructor() {
        this.values = new Map();
    }
    /**
     * Adds a new value to the params map.
     */
    addValue(placeholder, value, subTemplateIndex, flags) {
        const placeholderValues = this.values.get(placeholder) ?? [];
        placeholderValues.push({ value, subTemplateIndex, flags });
        this.values.set(placeholder, placeholderValues);
    }
    /**
     * Saves the params map, in serialized form, into the given i18n op.
     */
    saveToOp(op) {
        for (const [placeholder, placeholderValues] of this.values) {
            // We need to run post-processing for any 1i8n ops that contain parameters with more than one
            // value.
            if (placeholderValues.length > 1) {
                op.needsPostprocessing = true;
            }
            op.params.set(placeholder, o.literal(this.serializeValues(placeholderValues)));
        }
    }
    /**
     * Merges another param map into this one.
     */
    merge(other) {
        for (const [placeholder, otherValues] of other.values) {
            const currentValues = this.values.get(placeholder) || [];
            // Child element close tag params should be prepended to maintain the same order as
            // TemplateDefinitionBuilder.
            const flags = otherValues[0].flags;
            if ((flags & I18nParamValueFlags.CloseTag) && !(flags & I18nParamValueFlags.OpenTag)) {
                this.values.set(placeholder, [...otherValues, ...currentValues]);
            }
            else {
                this.values.set(placeholder, [...currentValues, ...otherValues]);
            }
        }
    }
    /**
     * Serializes a list of i18n placeholder values.
     */
    serializeValues(values) {
        const serializedValues = values.map(value => this.serializeValue(value));
        return serializedValues.length === 1 ?
            serializedValues[0] :
            `${LIST_START_MARKER}${serializedValues.join(LIST_DELIMITER)}${LIST_END_MARKER}`;
    }
    /**
     * Serializes a single i18n placeholder value.
     */
    serializeValue(value) {
        let tagMarker = '';
        let closeMarker = '';
        if (value.flags & I18nParamValueFlags.ElementTag) {
            tagMarker = ELEMENT_MARKER;
        }
        else if (value.flags & I18nParamValueFlags.TemplateTag) {
            tagMarker = TEMPLATE_MARKER;
        }
        if (tagMarker !== '') {
            closeMarker = value.flags & I18nParamValueFlags.CloseTag ? TAG_CLOSE_MARKER : '';
        }
        const context = value.subTemplateIndex === null ? '' : `${CONTEXT_MARKER}${value.subTemplateIndex}`;
        // Self-closing tags use a special form that concatenates the start and close tag values.
        if ((value.flags & I18nParamValueFlags.OpenTag) &&
            (value.flags & I18nParamValueFlags.CloseTag)) {
            return `${ESCAPE}${tagMarker}${value.value}${context}${ESCAPE}${ESCAPE}${closeMarker}${tagMarker}${value.value}${context}${ESCAPE}`;
        }
        return `${ESCAPE}${closeMarker}${tagMarker}${value.value}${context}${ESCAPE}`;
    }
}
/**
 * Resolve the placeholders in i18n messages.
 */
export function phaseResolveI18nPlaceholders(job) {
    const params = new Map();
    const i18nOps = new Map();
    resolvePlaceholders(job, params, i18nOps);
    propagatePlaceholders(params, i18nOps);
    // After colleccting all params, save them to the i18n ops.
    for (const [xref, i18nOpParams] of params) {
        i18nOpParams.saveToOp(i18nOps.get(xref));
    }
    // Validate the root i18n ops have all placeholders filled in.
    for (const op of i18nOps.values()) {
        if (op.xref === op.root) {
            for (const placeholder in op.message.placeholders) {
                if (!op.params.has(placeholder)) {
                    throw Error(`Failed to resolve i18n placeholder: ${placeholder}`);
                }
            }
        }
    }
}
/**
 * Resolve placeholders for each i18n op.
 */
function resolvePlaceholders(job, params, i18nOps) {
    for (const unit of job.units) {
        const elements = new Map();
        let currentI18nOp = null;
        // Record slots for tag name placeholders.
        for (const op of unit.create) {
            switch (op.kind) {
                case ir.OpKind.I18nStart:
                    i18nOps.set(op.xref, op);
                    currentI18nOp = op.kind === ir.OpKind.I18nStart ? op : null;
                    break;
                case ir.OpKind.I18nEnd:
                    currentI18nOp = null;
                    break;
                case ir.OpKind.ElementStart:
                    // For elements with i18n placeholders, record its slot value in the params map under the
                    // corresponding tag start placeholder.
                    if (op.i18nPlaceholder !== undefined) {
                        if (currentI18nOp === null) {
                            throw Error('i18n tag placeholder should only occur inside an i18n block');
                        }
                        elements.set(op.xref, op);
                        const { startName, closeName } = op.i18nPlaceholder;
                        let flags = I18nParamValueFlags.ElementTag | I18nParamValueFlags.OpenTag;
                        // For self-closing tags, there is no close tag placeholder. Instead, the start tag
                        // placeholder accounts for the start and close of the element.
                        if (closeName === '') {
                            flags |= I18nParamValueFlags.CloseTag;
                        }
                        addParam(params, currentI18nOp, startName, op.slot, currentI18nOp.subTemplateIndex, flags);
                    }
                    break;
                case ir.OpKind.ElementEnd:
                    const startOp = elements.get(op.xref);
                    if (startOp && startOp.i18nPlaceholder !== undefined) {
                        if (currentI18nOp === null) {
                            throw Error('i18n tag placeholder should only occur inside an i18n block');
                        }
                        const { closeName } = startOp.i18nPlaceholder;
                        // Self-closing tags don't have a closing tag placeholder.
                        if (closeName !== '') {
                            addParam(params, currentI18nOp, closeName, startOp.slot, currentI18nOp.subTemplateIndex, I18nParamValueFlags.ElementTag | I18nParamValueFlags.CloseTag);
                        }
                    }
                    break;
                case ir.OpKind.Template:
                    if (op.i18nPlaceholder !== undefined) {
                        if (currentI18nOp === null) {
                            throw Error('i18n tag placeholder should only occur inside an i18n block');
                        }
                        const subTemplateIndex = getSubTemplateIndexForTemplateTag(job, currentI18nOp, op);
                        addParam(params, currentI18nOp, op.i18nPlaceholder.startName, op.slot, subTemplateIndex, I18nParamValueFlags.TemplateTag);
                        addParam(params, currentI18nOp, op.i18nPlaceholder.closeName, op.slot, subTemplateIndex, I18nParamValueFlags.TemplateTag | I18nParamValueFlags.CloseTag);
                    }
                    break;
            }
        }
        // Fill in values for each of the i18n expression placeholders.
        const i18nBlockPlaceholderIndices = new Map();
        for (const op of unit.update) {
            if (op.kind === ir.OpKind.I18nExpression) {
                const i18nOp = i18nOps.get(op.owner);
                let index = i18nBlockPlaceholderIndices.get(op.owner) || 0;
                if (!i18nOp) {
                    throw Error('Cannot find corresponding i18nStart for i18nExpr');
                }
                addParam(params, i18nOp, op.i18nPlaceholder.name, index++, i18nOp.subTemplateIndex);
                i18nBlockPlaceholderIndices.set(op.owner, index);
            }
        }
    }
}
/**
 * Add a param to the params map for the given i18n op.
 */
function addParam(params, i18nOp, placeholder, value, subTemplateIndex, flags = I18nParamValueFlags.None) {
    const i18nOpParams = params.get(i18nOp.xref) || new I18nPlaceholderParams();
    i18nOpParams.addValue(placeholder, value, subTemplateIndex, flags);
    params.set(i18nOp.xref, i18nOpParams);
}
/**
 * Get the subTemplateIndex for the given template op. For template ops, use the subTemplateIndex of
 * the child i18n block inside the template.
 */
function getSubTemplateIndexForTemplateTag(job, i18nOp, op) {
    for (const childOp of job.views.get(op.xref).create) {
        if (childOp.kind === ir.OpKind.I18nStart) {
            return childOp.subTemplateIndex;
        }
    }
    return i18nOp.subTemplateIndex;
}
/**
 * Propagate placeholders up to their root i18n op.
 */
function propagatePlaceholders(params, i18nOps) {
    for (const [xref, opParams] of params) {
        const op = i18nOps.get(xref);
        if (op.xref !== op.root) {
            const rootParams = params.get(op.root) || new I18nPlaceholderParams();
            rootParams.merge(opParams);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZV9pMThuX3BsYWNlaG9sZGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvbXBpbGVyL3NyYy90ZW1wbGF0ZS9waXBlbGluZS9zcmMvcGhhc2VzL3Jlc29sdmVfaTE4bl9wbGFjZWhvbGRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBRUgsT0FBTyxLQUFLLENBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUNuRCxPQUFPLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUcvQjs7R0FFRztBQUNILE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQztBQUV4Qjs7R0FFRztBQUNILE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQztBQUUzQjs7R0FFRztBQUNILE1BQU0sZUFBZSxHQUFHLEdBQUcsQ0FBQztBQUU1Qjs7R0FFRztBQUNILE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxDQUFDO0FBRTdCOztHQUVHO0FBQ0gsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDO0FBRTNCOztHQUVHO0FBQ0gsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLENBQUM7QUFFOUI7O0dBRUc7QUFDSCxNQUFNLGVBQWUsR0FBRyxHQUFHLENBQUM7QUFFNUI7O0dBRUc7QUFDSCxNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUM7QUFFM0I7OztHQUdHO0FBQ0gsSUFBSyxtQkFzQko7QUF0QkQsV0FBSyxtQkFBbUI7SUFDdEIsNkRBQWEsQ0FBQTtJQUViOztPQUVHO0lBQ0gseUVBQWtCLENBQUE7SUFFbEI7O09BRUc7SUFDSCwyRUFBb0IsQ0FBQTtJQUVwQjs7T0FFRztJQUNILG1FQUFnQixDQUFBO0lBRWhCOztPQUVHO0lBQ0gscUVBQWlCLENBQUE7QUFDbkIsQ0FBQyxFQXRCSSxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBc0J2QjtBQXVCRDs7R0FFRztBQUNILE1BQU0scUJBQXFCO0lBQTNC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dEMsR0FBNEIsRUFBRSxNQUFzQixFQUFFLEVBQWlCO0lBQ3pFLEtBQUssTUFBTSxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBRSxDQUFDLE1BQU0sRUFBRTtRQUNwRCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDeEMsT0FBTyxPQUFPLENBQUMsZ0JBQWdCLENBQUM7U0FDakM7S0FDRjtJQUNELE9BQU8sTUFBTSxDQUFDLGdCQUFnQixDQUFDO0FBQ2pDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMscUJBQXFCLENBQzFCLE1BQTZDLEVBQUUsT0FBdUM7SUFDeEYsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxJQUFJLE1BQU0sRUFBRTtRQUNyQyxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBRSxDQUFDO1FBQzlCLElBQUksRUFBRSxDQUFDLElBQUksS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFO1lBQ3ZCLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUkscUJBQXFCLEVBQUUsQ0FBQztZQUN0RSxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzVCO0tBQ0Y7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCAqIGFzIG8gZnJvbSAnLi4vLi4vLi4vLi4vb3V0cHV0L291dHB1dF9hc3QnO1xuaW1wb3J0ICogYXMgaXIgZnJvbSAnLi4vLi4vaXInO1xuaW1wb3J0IHtDb21wb25lbnRDb21waWxhdGlvbkpvYn0gZnJvbSAnLi4vY29tcGlsYXRpb24nO1xuXG4vKipcbiAqIFRoZSBlc2NhcGUgc2VxdWVuY2UgdXNlZCBpbmRpY2F0ZSBtZXNzYWdlIHBhcmFtIHZhbHVlcy5cbiAqL1xuY29uc3QgRVNDQVBFID0gJ1xcdUZGRkQnO1xuXG4vKipcbiAqIE1hcmtlciB1c2VkIHRvIGluZGljYXRlIGFuIGVsZW1lbnQgdGFnLlxuICovXG5jb25zdCBFTEVNRU5UX01BUktFUiA9ICcjJztcblxuLyoqXG4gKiBNYXJrZXIgdXNlZCB0byBpbmRpY2F0ZSBhIHRlbXBsYXRlIHRhZy5cbiAqL1xuY29uc3QgVEVNUExBVEVfTUFSS0VSID0gJyonO1xuXG4vKipcbiAqIE1hcmtlciB1c2VkIHRvIGluZGljYXRlIGNsb3Npbmcgb2YgYW4gZWxlbWVudCBvciB0ZW1wbGF0ZSB0YWcuXG4gKi9cbmNvbnN0IFRBR19DTE9TRV9NQVJLRVIgPSAnLyc7XG5cbi8qKlxuICogTWFya2VyIHVzZWQgdG8gaW5kaWNhdGUgdGhlIHN1Yi10ZW1wbGF0ZSBjb250ZXh0LlxuICovXG5jb25zdCBDT05URVhUX01BUktFUiA9ICc6JztcblxuLyoqXG4gKiBNYXJrZXIgdXNlZCB0byBpbmRpY2F0ZSB0aGUgc3RhcnQgb2YgYSBsaXN0IG9mIHZhbHVlcy5cbiAqL1xuY29uc3QgTElTVF9TVEFSVF9NQVJLRVIgPSAnWyc7XG5cbi8qKlxuICogTWFya2VyIHVzZWQgdG8gaW5kaWNhdGUgdGhlIGVuZCBvZiBhIGxpc3Qgb2YgdmFsdWVzLlxuICovXG5jb25zdCBMSVNUX0VORF9NQVJLRVIgPSAnXSc7XG5cbi8qKlxuICogRGVsaW1pdGVyIHVzZWQgdG8gc2VwYXJhdGUgbXVsdGlwbGUgdmFsdWVzIGluIGEgbGlzdC5cbiAqL1xuY29uc3QgTElTVF9ERUxJTUlURVIgPSAnfCc7XG5cbi8qKlxuICogRmxhZ3MgdGhhdCBkZXNjcmliZSB3aGF0IGFuIGkxOG4gcGFyYW0gdmFsdWUuIFRoZXNlIGRldGVybWluZSBob3cgdGhlIHZhbHVlIGlzIHNlcmlhbGl6ZWQgaW50b1xuICogdGhlIGZpbmFsIG1hcC5cbiAqL1xuZW51bSBJMThuUGFyYW1WYWx1ZUZsYWdzIHtcbiAgTm9uZSA9IDBiMDAwMCxcblxuICAvKipcbiAgICogIFRoaXMgdmFsdWUgcmVwcmVzdGVudHMgYW4gZWxlbWVudCB0YWcuXG4gICAqL1xuICBFbGVtZW50VGFnID0gMGIwMDEsXG5cbiAgLyoqXG4gICAqIFRoaXMgdmFsdWUgcmVwcmVzZW50cyBhIHRlbXBsYXRlIHRhZy5cbiAgICovXG4gIFRlbXBsYXRlVGFnID0gMGIwMDEwLFxuXG4gIC8qKlxuICAgKiBUaGlzIHZhbHVlIHJlcHJlc2VudHMgdGhlIG9wZW5pbmcgb2YgYSB0YWcuXG4gICAqL1xuICBPcGVuVGFnID0gMGIwMTAwLFxuXG4gIC8qKlxuICAgKiBUaGlzIHZhbHVlIHJlcHJlc2VudHMgdGhlIGNsb3Npbmcgb2YgYSB0YWcuXG4gICAqL1xuICBDbG9zZVRhZyA9IDBiMTAwMCxcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGEgc2luZ2xlIHBsYWNlaG9sZGVyIHZhbHVlIGluIHRoZSBpMThuIHBhcmFtcyBtYXAuIFRoZSBtYXAgbWF5IGNvbnRhaW4gbXVsdGlwbGVcbiAqIEkxOG5QbGFjZWhvbGRlclZhbHVlIHBlciBwbGFjZWhvbGRlci5cbiAqL1xuaW50ZXJmYWNlIEkxOG5QbGFjZWhvbGRlclZhbHVlIHtcbiAgLyoqXG4gICAqIFRoZSB2YWx1ZS5cbiAgICovXG4gIHZhbHVlOiBzdHJpbmd8bnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgc3ViLXRlbXBsYXRlIGluZGV4IGFzc29jaWF0ZWQgd2l0aCB0aGUgdmFsdWUuXG4gICAqL1xuICBzdWJUZW1wbGF0ZUluZGV4OiBudW1iZXJ8bnVsbDtcblxuICAvKipcbiAgICogRmxhZ3MgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YWx1ZS5cbiAgICovXG4gIGZsYWdzOiBJMThuUGFyYW1WYWx1ZUZsYWdzO1xufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgdGhlIGNvbXBsZXRlIGkxOG4gcGFyYW1zIG1hcCBmb3IgYW4gaTE4biBvcC5cbiAqL1xuY2xhc3MgSTE4blBsYWNlaG9sZGVyUGFyYW1zIHtcbiAgdmFsdWVzID0gbmV3IE1hcDxzdHJpbmcsIEkxOG5QbGFjZWhvbGRlclZhbHVlW10+KCk7XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBuZXcgdmFsdWUgdG8gdGhlIHBhcmFtcyBtYXAuXG4gICAqL1xuICBhZGRWYWx1ZShcbiAgICAgIHBsYWNlaG9sZGVyOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmd8bnVtYmVyLCBzdWJUZW1wbGF0ZUluZGV4OiBudW1iZXJ8bnVsbCxcbiAgICAgIGZsYWdzOiBJMThuUGFyYW1WYWx1ZUZsYWdzKSB7XG4gICAgY29uc3QgcGxhY2Vob2xkZXJWYWx1ZXMgPSB0aGlzLnZhbHVlcy5nZXQocGxhY2Vob2xkZXIpID8/IFtdO1xuICAgIHBsYWNlaG9sZGVyVmFsdWVzLnB1c2goe3ZhbHVlLCBzdWJUZW1wbGF0ZUluZGV4LCBmbGFnc30pO1xuICAgIHRoaXMudmFsdWVzLnNldChwbGFjZWhvbGRlciwgcGxhY2Vob2xkZXJWYWx1ZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNhdmVzIHRoZSBwYXJhbXMgbWFwLCBpbiBzZXJpYWxpemVkIGZvcm0sIGludG8gdGhlIGdpdmVuIGkxOG4gb3AuXG4gICAqL1xuICBzYXZlVG9PcChvcDogaXIuSTE4blN0YXJ0T3ApIHtcbiAgICBmb3IgKGNvbnN0IFtwbGFjZWhvbGRlciwgcGxhY2Vob2xkZXJWYWx1ZXNdIG9mIHRoaXMudmFsdWVzKSB7XG4gICAgICAvLyBXZSBuZWVkIHRvIHJ1biBwb3N0LXByb2Nlc3NpbmcgZm9yIGFueSAxaThuIG9wcyB0aGF0IGNvbnRhaW4gcGFyYW1ldGVycyB3aXRoIG1vcmUgdGhhbiBvbmVcbiAgICAgIC8vIHZhbHVlLlxuICAgICAgaWYgKHBsYWNlaG9sZGVyVmFsdWVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgb3AubmVlZHNQb3N0cHJvY2Vzc2luZyA9IHRydWU7XG4gICAgICB9XG4gICAgICBvcC5wYXJhbXMuc2V0KHBsYWNlaG9sZGVyLCBvLmxpdGVyYWwodGhpcy5zZXJpYWxpemVWYWx1ZXMocGxhY2Vob2xkZXJWYWx1ZXMpKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE1lcmdlcyBhbm90aGVyIHBhcmFtIG1hcCBpbnRvIHRoaXMgb25lLlxuICAgKi9cbiAgbWVyZ2Uob3RoZXI6IEkxOG5QbGFjZWhvbGRlclBhcmFtcykge1xuICAgIGZvciAoY29uc3QgW3BsYWNlaG9sZGVyLCBvdGhlclZhbHVlc10gb2Ygb3RoZXIudmFsdWVzKSB7XG4gICAgICBjb25zdCBjdXJyZW50VmFsdWVzID0gdGhpcy52YWx1ZXMuZ2V0KHBsYWNlaG9sZGVyKSB8fCBbXTtcbiAgICAgIC8vIENoaWxkIGVsZW1lbnQgY2xvc2UgdGFnIHBhcmFtcyBzaG91bGQgYmUgcHJlcGVuZGVkIHRvIG1haW50YWluIHRoZSBzYW1lIG9yZGVyIGFzXG4gICAgICAvLyBUZW1wbGF0ZURlZmluaXRpb25CdWlsZGVyLlxuICAgICAgY29uc3QgZmxhZ3MgPSBvdGhlclZhbHVlc1swXSEuZmxhZ3M7XG4gICAgICBpZiAoKGZsYWdzICYgSTE4blBhcmFtVmFsdWVGbGFncy5DbG9zZVRhZykgJiYgIShmbGFncyAmIEkxOG5QYXJhbVZhbHVlRmxhZ3MuT3BlblRhZykpIHtcbiAgICAgICAgdGhpcy52YWx1ZXMuc2V0KHBsYWNlaG9sZGVyLCBbLi4ub3RoZXJWYWx1ZXMsIC4uLmN1cnJlbnRWYWx1ZXNdKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudmFsdWVzLnNldChwbGFjZWhvbGRlciwgWy4uLmN1cnJlbnRWYWx1ZXMsIC4uLm90aGVyVmFsdWVzXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlcmlhbGl6ZXMgYSBsaXN0IG9mIGkxOG4gcGxhY2Vob2xkZXIgdmFsdWVzLlxuICAgKi9cbiAgcHJpdmF0ZSBzZXJpYWxpemVWYWx1ZXModmFsdWVzOiBJMThuUGxhY2Vob2xkZXJWYWx1ZVtdKSB7XG4gICAgY29uc3Qgc2VyaWFsaXplZFZhbHVlcyA9IHZhbHVlcy5tYXAodmFsdWUgPT4gdGhpcy5zZXJpYWxpemVWYWx1ZSh2YWx1ZSkpO1xuICAgIHJldHVybiBzZXJpYWxpemVkVmFsdWVzLmxlbmd0aCA9PT0gMSA/XG4gICAgICAgIHNlcmlhbGl6ZWRWYWx1ZXNbMF0gOlxuICAgICAgICBgJHtMSVNUX1NUQVJUX01BUktFUn0ke3NlcmlhbGl6ZWRWYWx1ZXMuam9pbihMSVNUX0RFTElNSVRFUil9JHtMSVNUX0VORF9NQVJLRVJ9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXJpYWxpemVzIGEgc2luZ2xlIGkxOG4gcGxhY2Vob2xkZXIgdmFsdWUuXG4gICAqL1xuICBwcml2YXRlIHNlcmlhbGl6ZVZhbHVlKHZhbHVlOiBJMThuUGxhY2Vob2xkZXJWYWx1ZSkge1xuICAgIGxldCB0YWdNYXJrZXIgPSAnJztcbiAgICBsZXQgY2xvc2VNYXJrZXIgPSAnJztcbiAgICBpZiAodmFsdWUuZmxhZ3MgJiBJMThuUGFyYW1WYWx1ZUZsYWdzLkVsZW1lbnRUYWcpIHtcbiAgICAgIHRhZ01hcmtlciA9IEVMRU1FTlRfTUFSS0VSO1xuICAgIH0gZWxzZSBpZiAodmFsdWUuZmxhZ3MgJiBJMThuUGFyYW1WYWx1ZUZsYWdzLlRlbXBsYXRlVGFnKSB7XG4gICAgICB0YWdNYXJrZXIgPSBURU1QTEFURV9NQVJLRVI7XG4gICAgfVxuICAgIGlmICh0YWdNYXJrZXIgIT09ICcnKSB7XG4gICAgICBjbG9zZU1hcmtlciA9IHZhbHVlLmZsYWdzICYgSTE4blBhcmFtVmFsdWVGbGFncy5DbG9zZVRhZyA/IFRBR19DTE9TRV9NQVJLRVIgOiAnJztcbiAgICB9XG4gICAgY29uc3QgY29udGV4dCA9XG4gICAgICAgIHZhbHVlLnN1YlRlbXBsYXRlSW5kZXggPT09IG51bGwgPyAnJyA6IGAke0NPTlRFWFRfTUFSS0VSfSR7dmFsdWUuc3ViVGVtcGxhdGVJbmRleH1gO1xuICAgIC8vIFNlbGYtY2xvc2luZyB0YWdzIHVzZSBhIHNwZWNpYWwgZm9ybSB0aGF0IGNvbmNhdGVuYXRlcyB0aGUgc3RhcnQgYW5kIGNsb3NlIHRhZyB2YWx1ZXMuXG4gICAgaWYgKCh2YWx1ZS5mbGFncyAmIEkxOG5QYXJhbVZhbHVlRmxhZ3MuT3BlblRhZykgJiZcbiAgICAgICAgKHZhbHVlLmZsYWdzICYgSTE4blBhcmFtVmFsdWVGbGFncy5DbG9zZVRhZykpIHtcbiAgICAgIHJldHVybiBgJHtFU0NBUEV9JHt0YWdNYXJrZXJ9JHt2YWx1ZS52YWx1ZX0ke2NvbnRleHR9JHtFU0NBUEV9JHtFU0NBUEV9JHtjbG9zZU1hcmtlcn0ke1xuICAgICAgICAgIHRhZ01hcmtlcn0ke3ZhbHVlLnZhbHVlfSR7Y29udGV4dH0ke0VTQ0FQRX1gO1xuICAgIH1cbiAgICByZXR1cm4gYCR7RVNDQVBFfSR7Y2xvc2VNYXJrZXJ9JHt0YWdNYXJrZXJ9JHt2YWx1ZS52YWx1ZX0ke2NvbnRleHR9JHtFU0NBUEV9YDtcbiAgfVxufVxuXG4vKipcbiAqIFJlc29sdmUgdGhlIHBsYWNlaG9sZGVycyBpbiBpMThuIG1lc3NhZ2VzLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcGhhc2VSZXNvbHZlSTE4blBsYWNlaG9sZGVycyhqb2I6IENvbXBvbmVudENvbXBpbGF0aW9uSm9iKSB7XG4gIGNvbnN0IHBhcmFtcyA9IG5ldyBNYXA8aXIuWHJlZklkLCBJMThuUGxhY2Vob2xkZXJQYXJhbXM+KCk7XG4gIGNvbnN0IGkxOG5PcHMgPSBuZXcgTWFwPGlyLlhyZWZJZCwgaXIuSTE4blN0YXJ0T3A+KCk7XG5cbiAgcmVzb2x2ZVBsYWNlaG9sZGVycyhqb2IsIHBhcmFtcywgaTE4bk9wcyk7XG4gIHByb3BhZ2F0ZVBsYWNlaG9sZGVycyhwYXJhbXMsIGkxOG5PcHMpO1xuXG4gIC8vIEFmdGVyIGNvbGxlY2N0aW5nIGFsbCBwYXJhbXMsIHNhdmUgdGhlbSB0byB0aGUgaTE4biBvcHMuXG4gIGZvciAoY29uc3QgW3hyZWYsIGkxOG5PcFBhcmFtc10gb2YgcGFyYW1zKSB7XG4gICAgaTE4bk9wUGFyYW1zLnNhdmVUb09wKGkxOG5PcHMuZ2V0KHhyZWYpISk7XG4gIH1cblxuICAvLyBWYWxpZGF0ZSB0aGUgcm9vdCBpMThuIG9wcyBoYXZlIGFsbCBwbGFjZWhvbGRlcnMgZmlsbGVkIGluLlxuICBmb3IgKGNvbnN0IG9wIG9mIGkxOG5PcHMudmFsdWVzKCkpIHtcbiAgICBpZiAob3AueHJlZiA9PT0gb3Aucm9vdCkge1xuICAgICAgZm9yIChjb25zdCBwbGFjZWhvbGRlciBpbiBvcC5tZXNzYWdlLnBsYWNlaG9sZGVycykge1xuICAgICAgICBpZiAoIW9wLnBhcmFtcy5oYXMocGxhY2Vob2xkZXIpKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoYEZhaWxlZCB0byByZXNvbHZlIGkxOG4gcGxhY2Vob2xkZXI6ICR7cGxhY2Vob2xkZXJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNvbHZlIHBsYWNlaG9sZGVycyBmb3IgZWFjaCBpMThuIG9wLlxuICovXG5mdW5jdGlvbiByZXNvbHZlUGxhY2Vob2xkZXJzKFxuICAgIGpvYjogQ29tcG9uZW50Q29tcGlsYXRpb25Kb2IsIHBhcmFtczogTWFwPGlyLlhyZWZJZCwgSTE4blBsYWNlaG9sZGVyUGFyYW1zPixcbiAgICBpMThuT3BzOiBNYXA8aXIuWHJlZklkLCBpci5JMThuU3RhcnRPcD4pIHtcbiAgZm9yIChjb25zdCB1bml0IG9mIGpvYi51bml0cykge1xuICAgIGNvbnN0IGVsZW1lbnRzID0gbmV3IE1hcDxpci5YcmVmSWQsIGlyLkVsZW1lbnRTdGFydE9wPigpO1xuICAgIGxldCBjdXJyZW50STE4bk9wOiBpci5JMThuU3RhcnRPcHxudWxsID0gbnVsbDtcblxuICAgIC8vIFJlY29yZCBzbG90cyBmb3IgdGFnIG5hbWUgcGxhY2Vob2xkZXJzLlxuICAgIGZvciAoY29uc3Qgb3Agb2YgdW5pdC5jcmVhdGUpIHtcbiAgICAgIHN3aXRjaCAob3Aua2luZCkge1xuICAgICAgICBjYXNlIGlyLk9wS2luZC5JMThuU3RhcnQ6XG4gICAgICAgICAgaTE4bk9wcy5zZXQob3AueHJlZiwgb3ApO1xuICAgICAgICAgIGN1cnJlbnRJMThuT3AgPSBvcC5raW5kID09PSBpci5PcEtpbmQuSTE4blN0YXJ0ID8gb3AgOiBudWxsO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIGlyLk9wS2luZC5JMThuRW5kOlxuICAgICAgICAgIGN1cnJlbnRJMThuT3AgPSBudWxsO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIGlyLk9wS2luZC5FbGVtZW50U3RhcnQ6XG4gICAgICAgICAgLy8gRm9yIGVsZW1lbnRzIHdpdGggaTE4biBwbGFjZWhvbGRlcnMsIHJlY29yZCBpdHMgc2xvdCB2YWx1ZSBpbiB0aGUgcGFyYW1zIG1hcCB1bmRlciB0aGVcbiAgICAgICAgICAvLyBjb3JyZXNwb25kaW5nIHRhZyBzdGFydCBwbGFjZWhvbGRlci5cbiAgICAgICAgICBpZiAob3AuaTE4blBsYWNlaG9sZGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlmIChjdXJyZW50STE4bk9wID09PSBudWxsKSB7XG4gICAgICAgICAgICAgIHRocm93IEVycm9yKCdpMThuIHRhZyBwbGFjZWhvbGRlciBzaG91bGQgb25seSBvY2N1ciBpbnNpZGUgYW4gaTE4biBibG9jaycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxlbWVudHMuc2V0KG9wLnhyZWYsIG9wKTtcbiAgICAgICAgICAgIGNvbnN0IHtzdGFydE5hbWUsIGNsb3NlTmFtZX0gPSBvcC5pMThuUGxhY2Vob2xkZXI7XG4gICAgICAgICAgICBsZXQgZmxhZ3MgPSBJMThuUGFyYW1WYWx1ZUZsYWdzLkVsZW1lbnRUYWcgfCBJMThuUGFyYW1WYWx1ZUZsYWdzLk9wZW5UYWc7XG4gICAgICAgICAgICAvLyBGb3Igc2VsZi1jbG9zaW5nIHRhZ3MsIHRoZXJlIGlzIG5vIGNsb3NlIHRhZyBwbGFjZWhvbGRlci4gSW5zdGVhZCwgdGhlIHN0YXJ0IHRhZ1xuICAgICAgICAgICAgLy8gcGxhY2Vob2xkZXIgYWNjb3VudHMgZm9yIHRoZSBzdGFydCBhbmQgY2xvc2Ugb2YgdGhlIGVsZW1lbnQuXG4gICAgICAgICAgICBpZiAoY2xvc2VOYW1lID09PSAnJykge1xuICAgICAgICAgICAgICBmbGFncyB8PSBJMThuUGFyYW1WYWx1ZUZsYWdzLkNsb3NlVGFnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWRkUGFyYW0oXG4gICAgICAgICAgICAgICAgcGFyYW1zLCBjdXJyZW50STE4bk9wLCBzdGFydE5hbWUsIG9wLnNsb3QhLCBjdXJyZW50STE4bk9wLnN1YlRlbXBsYXRlSW5kZXgsIGZsYWdzKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgaXIuT3BLaW5kLkVsZW1lbnRFbmQ6XG4gICAgICAgICAgY29uc3Qgc3RhcnRPcCA9IGVsZW1lbnRzLmdldChvcC54cmVmKTtcbiAgICAgICAgICBpZiAoc3RhcnRPcCAmJiBzdGFydE9wLmkxOG5QbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpZiAoY3VycmVudEkxOG5PcCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICB0aHJvdyBFcnJvcignaTE4biB0YWcgcGxhY2Vob2xkZXIgc2hvdWxkIG9ubHkgb2NjdXIgaW5zaWRlIGFuIGkxOG4gYmxvY2snKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHtjbG9zZU5hbWV9ID0gc3RhcnRPcC5pMThuUGxhY2Vob2xkZXI7XG4gICAgICAgICAgICAvLyBTZWxmLWNsb3NpbmcgdGFncyBkb24ndCBoYXZlIGEgY2xvc2luZyB0YWcgcGxhY2Vob2xkZXIuXG4gICAgICAgICAgICBpZiAoY2xvc2VOYW1lICE9PSAnJykge1xuICAgICAgICAgICAgICBhZGRQYXJhbShcbiAgICAgICAgICAgICAgICAgIHBhcmFtcywgY3VycmVudEkxOG5PcCwgY2xvc2VOYW1lLCBzdGFydE9wLnNsb3QhLCBjdXJyZW50STE4bk9wLnN1YlRlbXBsYXRlSW5kZXgsXG4gICAgICAgICAgICAgICAgICBJMThuUGFyYW1WYWx1ZUZsYWdzLkVsZW1lbnRUYWcgfCBJMThuUGFyYW1WYWx1ZUZsYWdzLkNsb3NlVGFnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgaXIuT3BLaW5kLlRlbXBsYXRlOlxuICAgICAgICAgIGlmIChvcC5pMThuUGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRJMThuT3AgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ2kxOG4gdGFnIHBsYWNlaG9sZGVyIHNob3VsZCBvbmx5IG9jY3VyIGluc2lkZSBhbiBpMThuIGJsb2NrJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBzdWJUZW1wbGF0ZUluZGV4ID0gZ2V0U3ViVGVtcGxhdGVJbmRleEZvclRlbXBsYXRlVGFnKGpvYiwgY3VycmVudEkxOG5PcCwgb3ApO1xuICAgICAgICAgICAgYWRkUGFyYW0oXG4gICAgICAgICAgICAgICAgcGFyYW1zLCBjdXJyZW50STE4bk9wLCBvcC5pMThuUGxhY2Vob2xkZXIuc3RhcnROYW1lLCBvcC5zbG90ISwgc3ViVGVtcGxhdGVJbmRleCxcbiAgICAgICAgICAgICAgICBJMThuUGFyYW1WYWx1ZUZsYWdzLlRlbXBsYXRlVGFnKTtcbiAgICAgICAgICAgIGFkZFBhcmFtKFxuICAgICAgICAgICAgICAgIHBhcmFtcywgY3VycmVudEkxOG5PcCwgb3AuaTE4blBsYWNlaG9sZGVyLmNsb3NlTmFtZSwgb3Auc2xvdCEsIHN1YlRlbXBsYXRlSW5kZXgsXG4gICAgICAgICAgICAgICAgSTE4blBhcmFtVmFsdWVGbGFncy5UZW1wbGF0ZVRhZyB8IEkxOG5QYXJhbVZhbHVlRmxhZ3MuQ2xvc2VUYWcpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBGaWxsIGluIHZhbHVlcyBmb3IgZWFjaCBvZiB0aGUgaTE4biBleHByZXNzaW9uIHBsYWNlaG9sZGVycy5cbiAgICBjb25zdCBpMThuQmxvY2tQbGFjZWhvbGRlckluZGljZXMgPSBuZXcgTWFwPGlyLlhyZWZJZCwgbnVtYmVyPigpO1xuICAgIGZvciAoY29uc3Qgb3Agb2YgdW5pdC51cGRhdGUpIHtcbiAgICAgIGlmIChvcC5raW5kID09PSBpci5PcEtpbmQuSTE4bkV4cHJlc3Npb24pIHtcbiAgICAgICAgY29uc3QgaTE4bk9wID0gaTE4bk9wcy5nZXQob3Aub3duZXIpO1xuICAgICAgICBsZXQgaW5kZXggPSBpMThuQmxvY2tQbGFjZWhvbGRlckluZGljZXMuZ2V0KG9wLm93bmVyKSB8fCAwO1xuICAgICAgICBpZiAoIWkxOG5PcCkge1xuICAgICAgICAgIHRocm93IEVycm9yKCdDYW5ub3QgZmluZCBjb3JyZXNwb25kaW5nIGkxOG5TdGFydCBmb3IgaTE4bkV4cHInKTtcbiAgICAgICAgfVxuICAgICAgICBhZGRQYXJhbShwYXJhbXMsIGkxOG5PcCwgb3AuaTE4blBsYWNlaG9sZGVyLm5hbWUsIGluZGV4KyssIGkxOG5PcC5zdWJUZW1wbGF0ZUluZGV4KTtcbiAgICAgICAgaTE4bkJsb2NrUGxhY2Vob2xkZXJJbmRpY2VzLnNldChvcC5vd25lciwgaW5kZXgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEFkZCBhIHBhcmFtIHRvIHRoZSBwYXJhbXMgbWFwIGZvciB0aGUgZ2l2ZW4gaTE4biBvcC5cbiAqL1xuZnVuY3Rpb24gYWRkUGFyYW0oXG4gICAgcGFyYW1zOiBNYXA8aXIuWHJlZklkLCBJMThuUGxhY2Vob2xkZXJQYXJhbXM+LCBpMThuT3A6IGlyLkkxOG5TdGFydE9wLCBwbGFjZWhvbGRlcjogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmd8bnVtYmVyLCBzdWJUZW1wbGF0ZUluZGV4OiBudW1iZXJ8bnVsbCxcbiAgICBmbGFnczogSTE4blBhcmFtVmFsdWVGbGFncyA9IEkxOG5QYXJhbVZhbHVlRmxhZ3MuTm9uZSkge1xuICBjb25zdCBpMThuT3BQYXJhbXMgPSBwYXJhbXMuZ2V0KGkxOG5PcC54cmVmKSB8fCBuZXcgSTE4blBsYWNlaG9sZGVyUGFyYW1zKCk7XG4gIGkxOG5PcFBhcmFtcy5hZGRWYWx1ZShwbGFjZWhvbGRlciwgdmFsdWUsIHN1YlRlbXBsYXRlSW5kZXgsIGZsYWdzKTtcbiAgcGFyYW1zLnNldChpMThuT3AueHJlZiwgaTE4bk9wUGFyYW1zKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIHN1YlRlbXBsYXRlSW5kZXggZm9yIHRoZSBnaXZlbiB0ZW1wbGF0ZSBvcC4gRm9yIHRlbXBsYXRlIG9wcywgdXNlIHRoZSBzdWJUZW1wbGF0ZUluZGV4IG9mXG4gKiB0aGUgY2hpbGQgaTE4biBibG9jayBpbnNpZGUgdGhlIHRlbXBsYXRlLlxuICovXG5mdW5jdGlvbiBnZXRTdWJUZW1wbGF0ZUluZGV4Rm9yVGVtcGxhdGVUYWcoXG4gICAgam9iOiBDb21wb25lbnRDb21waWxhdGlvbkpvYiwgaTE4bk9wOiBpci5JMThuU3RhcnRPcCwgb3A6IGlyLlRlbXBsYXRlT3ApOiBudW1iZXJ8bnVsbCB7XG4gIGZvciAoY29uc3QgY2hpbGRPcCBvZiBqb2Iudmlld3MuZ2V0KG9wLnhyZWYpIS5jcmVhdGUpIHtcbiAgICBpZiAoY2hpbGRPcC5raW5kID09PSBpci5PcEtpbmQuSTE4blN0YXJ0KSB7XG4gICAgICByZXR1cm4gY2hpbGRPcC5zdWJUZW1wbGF0ZUluZGV4O1xuICAgIH1cbiAgfVxuICByZXR1cm4gaTE4bk9wLnN1YlRlbXBsYXRlSW5kZXg7XG59XG5cbi8qKlxuICogUHJvcGFnYXRlIHBsYWNlaG9sZGVycyB1cCB0byB0aGVpciByb290IGkxOG4gb3AuXG4gKi9cbmZ1bmN0aW9uIHByb3BhZ2F0ZVBsYWNlaG9sZGVycyhcbiAgICBwYXJhbXM6IE1hcDxpci5YcmVmSWQsIEkxOG5QbGFjZWhvbGRlclBhcmFtcz4sIGkxOG5PcHM6IE1hcDxpci5YcmVmSWQsIGlyLkkxOG5TdGFydE9wPikge1xuICBmb3IgKGNvbnN0IFt4cmVmLCBvcFBhcmFtc10gb2YgcGFyYW1zKSB7XG4gICAgY29uc3Qgb3AgPSBpMThuT3BzLmdldCh4cmVmKSE7XG4gICAgaWYgKG9wLnhyZWYgIT09IG9wLnJvb3QpIHtcbiAgICAgIGNvbnN0IHJvb3RQYXJhbXMgPSBwYXJhbXMuZ2V0KG9wLnJvb3QpIHx8IG5ldyBJMThuUGxhY2Vob2xkZXJQYXJhbXMoKTtcbiAgICAgIHJvb3RQYXJhbXMubWVyZ2Uob3BQYXJhbXMpO1xuICAgIH1cbiAgfVxufVxuIl19